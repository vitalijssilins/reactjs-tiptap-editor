"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const p=require("./index-CSvnpArE.cjs"),b=require("./index-ugE1dRs4.cjs"),c=require("react/jsx-runtime"),l=require("react"),v=require("./clsx-C11secjj.cjs"),C=require("./index-BObJ0_Vs.cjs"),g=require("./editableEditor-CliumnBo.cjs"),x=require("./ActionButton-DY0olRIe.cjs"),T="_toc_aag8a_1",O="_visible_aag8a_7",_="_list_aag8a_11",y="_item_aag8a_16",f={toc:T,visible:O,list:_,item:y};function N(e){const o=[],i=[o];return e.forEach(n=>{let t=-1,s=i[n.level+t];for(;!s;)t-=1,s=i[n.level+t];s.push({...n,children:i[n.level]=[]})}),o}function A({editor:e}){const o=g.useEditableEditor(),[i,n]=l.useState([]),{t}=C.useLocale(),s=l.useCallback(()=>{const a=[],r=e.state.tr;e.state.doc.descendants((u,m)=>{if(u.type.name==="heading"){const d=`heading-${a.length+1}`;u.attrs.id!==d&&r.setNodeMarkup(m,void 0,{...u.attrs,id:d}),a.push({level:u.attrs.level,text:u.textContent,id:d})}}),r.setMeta("addToHistory",!1),r.setMeta("preventUpdate",!0),e.view.dispatch(r),n(a),e.eventEmitter&&e.eventEmitter.emit("TableOfContents",N(a))},[e]);return l.useEffect(()=>{if(e){if(!e.options.editable){s();return}return e.on("update",s),()=>{e.off("update",s)}}},[e,s]),l.useEffect(()=>{s()},[]),c.jsx(b.NodeViewWrapper,{className:v.clsx("tableOfContent",f.toc,o&&f.visible),children:o?c.jsxs("div",{style:{position:"relative"},children:[c.jsx("p",{className:"text-[20px] richtext-mb-[8px] richtext-font-semibold",children:t("editor.table_of_content")}),c.jsx("ul",{className:f.list,children:i.map((a,r)=>c.jsx("li",{className:f.item,style:{paddingLeft:`${a.level-1}rem`},children:c.jsx("a",{href:`#${a.id}`,children:a.text})},`table-of-content-${r}`))})]}):null})}function E(e,...o){const[i,n]=l.useState(!1);return l.useEffect(()=>{const t=()=>{n(e.isActive.apply(e,o))};return e.on("selectionUpdate",t),e.on("transaction",t),()=>{e.off("selectionUpdate",t),e.off("transaction",t)}},[e,o,n]),i}function j({editor:e,icon:o,tooltip:i}){const n=E(e,h.name),t=l.useCallback(()=>{if(n){e.chain().focus().removeTableOfContents().run();return}e.chain().focus().setTableOfContents().run()},[e,n]);return c.jsx(x.ActionButton,{action:t,isActive:()=>n||!1,icon:o,tooltip:i})}function q(e){return e&&e.type.name==="title"}function w(e,o){const n=[e.getJSON()],t=[];for(;n.length>0;){const s=n.shift();s.type===o&&t.push(s),s.content&&s.content.length>0&&n.push(...s.content)}return t}const h=p.Node.create({name:"tableOfContents",group:"block",atom:!0,addOptions(){var e;return{...(e=this.parent)==null?void 0:e.call(this),onHasOneBeforeInsert:()=>{},resizable:!0,lastColumnResizable:!0,allowTableNodeSelection:!1,button:({editor:o,t:i})=>({component:j,componentProps:{disabled:!1,icon:"BookMarked",tooltip:i("editor.table_of_content"),editor:o}})}},parseHTML(){return[{tag:"toc"}]},renderHTML({HTMLAttributes:e}){return["toc",p.mergeAttributes(e)]},addNodeView(){return b.ReactNodeViewRenderer(A)},addCommands(){return{setTableOfContents:()=>({commands:e,editor:o,view:i})=>{if(w(o,this.name).length>0){this.options.onHasOneBeforeInsert();return}const t=i.props.state.doc.content.firstChild;if(q(t)){const s=(t.firstChild&&t.firstChild.nodeSize||0)+1;return e.insertContentAt(s,{type:this.name})}return e.insertContent({type:this.name})},removeTableOfContents:()=>({state:e,dispatch:o})=>{const{tr:i}=e,n=e.schema.nodes.tableOfContents;return e.doc.descendants((t,s)=>{if(t.type===n){const a=s,r=s+t.nodeSize;i.delete(a,r)}}),i.docChanged?(o(i),!0):!1}}},addGlobalAttributes(){return[{types:["heading"],attributes:{id:{default:null}}}]}});exports.TableOfContents=h;

"use strict";var X=Object.create;var G=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var Y=Object.getPrototypeOf,J=Object.prototype.hasOwnProperty;var K=(t,e,r,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let l of Z(e))!J.call(t,l)&&l!==r&&G(t,l,{get:()=>e[l],enumerable:!(a=U(e,l))||a.enumerable});return t};var Q=(t,e,r)=>(r=t!=null?X(Y(t)):{},K(e||!t||!t.__esModule?G(r,"default",{value:t,enumerable:!0}):r,t));Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const k=require("./index-CSvnpArE.cjs"),$=require("./index-DBoalRcu.cjs"),V=require("./index-ugE1dRs4.cjs"),o=require("react/jsx-runtime"),s=require("react"),P=require("./shortId-Bfj8TyNr.cjs"),ee=require("./ActionButton-DY0olRIe.cjs"),I=require("./dialog-CVd5Mqbw.cjs"),te=require("./textarea-BYF4nPuF.cjs"),re=require("./file-i7e4nQY2.cjs"),ie=require("./button-BT4Gvjni.cjs"),S=require("./index-CWKNKm3Y.cjs"),se=require("./utils-DmD36e1i.cjs"),F=`graph TB
a-->b`,ae=({editor:t,upload:e})=>{const[r,a]=s.useState(F),[l,w]=s.useState(""),[v,T]=s.useState(!1),A=s.useRef(null),[u,d]=s.useState(null),E=s.useCallback(c=>{c&&import("mermaid").then(p=>{d(p.default)})},[]),y=async c=>{try{const{svg:p}=await u.render("mermaid-svg",c);w(p)}catch{w("")}},L=()=>{u.initialize({darkMode:!1,startOnLoad:!1,fontSize:12,theme:"base"}),y(r)};s.useEffect(()=>{u&&v&&L()},[u,v]),s.useEffect(()=>{u&&v&&y(r)},[u&&r]);const R=async()=>{if(r!==""){if(r){const c=A.current.querySelector("svg"),{width:p,height:j}=c.getBoundingClientRect(),_=`mermaid-${P.shortId()}.svg`;let x=P.i(c.outerHTML);if(e){console.log({src:x});const H=re.dataURLtoFile(x,_);x=await e(H)}t==null||t.chain().focus().setMermaid({type:"mermaid",src:x,alt:encodeURIComponent(r),width:p,height:j},!!r).run()}T(!1)}};return o.jsxs(I.Dialog,{onOpenChange:T,open:v,children:[o.jsx(I.DialogTrigger,{asChild:!0,children:o.jsx(ee.ActionButton,{action:()=>T(!0),icon:"Mermaid",tooltip:"Mermaid"})}),o.jsxs(I.DialogContent,{className:"richtext-z-[99999] !richtext-max-w-[1300px]",children:[o.jsx(I.DialogTitle,{children:"Mermaid"}),o.jsx("div",{ref:E,style:{height:"100%",border:"1px solid hsl(var(--border))"},children:o.jsxs("div",{className:"richtext-flex richtext-gap-[10px] richtext-rounded-[10px] richtext-p-[10px]",children:[o.jsx(te.Textarea,{autoFocus:!0,className:"richtext-flex-1",defaultValue:F,onChange:c=>a(c.target.value),placeholder:"Text",required:!0,rows:10,value:r,style:{color:"hsl(var(--richtext-foreground))"}}),o.jsx("div",{className:"richtext-flex richtext-flex-1 richtext-items-center richtext-justify-center richtext-rounded-[10px] richtext-p-[10px]",dangerouslySetInnerHTML:{__html:l},ref:A,style:{height:"100%",borderWidth:1,minHeight:500,background:"#fff"}})]})}),o.jsx(I.DialogFooter,{children:o.jsx(ie.Button,{onClick:R,type:"button",children:"Save changes"})})]})]})},O={TOP_LEFT:"tl",TOP_RIGHT:"tr",BOTTOM_LEFT:"bl",BOTTOM_RIGHT:"br"};function ne({editor:t,node:e,updateAttributes:r,getPos:a,selected:l}){const[w,v]=s.useState({width:S.IMAGE_MAX_SIZE,height:S.IMAGE_MAX_SIZE}),[T,A]=s.useState({width:0,height:0}),[u]=s.useState([O.TOP_LEFT,O.TOP_RIGHT,O.BOTTOM_LEFT,O.BOTTOM_RIGHT]),[d,E]=s.useState(!1),[y,L]=s.useState({x:0,y:0,w:0,h:0,dir:""}),{align:R}=e==null?void 0:e.attrs,c=s.useMemo(()=>{const{src:i,alt:g,width:m,height:M}=e==null?void 0:e.attrs,b=k.isNumber(m)?`${m}px`:m,n=k.isNumber(M)?`${M}px`:M;return{src:i||void 0,alt:g||void 0,style:{width:b||void 0,height:n||void 0}}},[e==null?void 0:e.attrs]),p=s.useMemo(()=>{const{style:{width:i}}=c;return{width:i==="100%"?i:void 0}},[c]);function j(i){A({width:i.target.width,height:i.target.height})}function _(){t.commands.setNodeSelection(a())}const x=s.useCallback($.throttle(()=>{const{width:i}=getComputedStyle(t.view.dom);v(g=>({...g,width:Number.parseInt(i,10)}))},S.IMAGE_THROTTLE_WAIT_TIME),[t]);function H(i,g){i.preventDefault(),i.stopPropagation();const m=T.width,M=T.height,b=m/M;let n=Number(e.attrs.width),f=Number(e.attrs.height);const h=w.width;n&&!f?(n=n>h?h:n,f=Math.round(n/b)):f&&!n?(n=Math.round(f*b),n=n>h?h:n):!n&&!f?(n=m>h?h:m,f=Math.round(n/b)):n=n>h?h:n,E(!0),L({x:i.clientX,y:i.clientY,w:n,h:f,dir:g})}const N=s.useCallback($.throttle(i=>{if(i.preventDefault(),i.stopPropagation(),!d)return;const{x:g,w:m,dir:M}=y,b=(i.clientX-g)*(/l/.test(M)?-1:1),{width:n,height:f}=e==null?void 0:e.attrs,h=n/f,D=se.clamp(m+b,S.IMAGE_MIN_SIZE,w.width),W=Math.round(D/h);r({width:D,height:W})},S.IMAGE_THROTTLE_WAIT_TIME),[d,y,w,r,e==null?void 0:e.attrs]),C=s.useCallback(i=>{i.preventDefault(),i.stopPropagation(),d&&(L({x:0,y:0,w:0,h:0,dir:""}),E(!1),_())},[d,_]),B=s.useCallback(()=>{document==null||document.addEventListener("mousemove",N,!0),document==null||document.addEventListener("mouseup",C,!0)},[N,C]),q=s.useCallback(()=>{document==null||document.removeEventListener("mousemove",N,!0),document==null||document.removeEventListener("mouseup",C,!0)},[N,C]);s.useEffect(()=>(d?B():q(),()=>{q()}),[d,B,q]);const z=s.useMemo(()=>new ResizeObserver(()=>x()),[x]);return s.useEffect(()=>(z.observe(t.view.dom),()=>{z.disconnect()}),[t.view.dom,z]),o.jsx(V.NodeViewWrapper,{className:"image-view",style:{...p,width:"100%",textAlign:R},children:o.jsxs("div",{"data-drag-handle":!0,draggable:"true",style:{...p,background:"#fff"},className:`image-view__body ${l?"image-view__body--focused":""} ${d?"image-view__body--resizing":""}`,children:[o.jsx("img",{alt:c.alt,className:"image-view__body__image block",height:"auto",onClick:_,onLoad:j,src:c.src,style:c.style}),t.view.editable&&(l||d)&&o.jsx("div",{className:"image-resizer",children:u==null?void 0:u.map(i=>o.jsx("span",{className:`image-resizer__handler image-resizer__handler--${i}`,onMouseDown:g=>H(g,i)},`image-dir-${i}`))})]})})}const oe=$.Image.extend({name:"mermaid",addOptions(){var t;return{...(t=this.parent)==null?void 0:t.call(this),inline:!1,content:"",marks:"",group:"block",draggable:!1,selectable:!0,atom:!0,HTMLAttributes:{class:"mermaid"},button:({editor:e,t:r,extension:a})=>{var l;return{component:ae,componentProps:{action:()=>!0,isActive:()=>!1,disabled:!1,editor:e,icon:"Mermaid",tooltip:r("editor.mermaid.tooltip"),upload:(l=a==null?void 0:a.options)==null?void 0:l.upload}}}}},addAttributes(){var t;return{...(t=this.parent)==null?void 0:t.call(this),width:{default:null,parseHTML:e=>{const r=e.querySelector("img"),a=r==null?void 0:r.getAttribute("width");return a?Number.parseInt(a,10):320},renderHTML:e=>({width:e.width})},height:{default:null,parseHTML:e=>{const r=e.querySelector("img"),a=r==null?void 0:r.getAttribute("height");return a?Number.parseInt(a,10):212},renderHTML:e=>({height:e.height})},align:{default:"center",parseHTML:e=>e.getAttribute("align"),renderHTML:e=>({align:e.align})}}},addNodeView(){return V.ReactNodeViewRenderer(ne)},addCommands(){return{setMermaid:(t,e)=>({commands:r,editor:a})=>e?r.insertContent({type:this.name,attrs:t}):r.insertContentAt(a.state.selection.anchor,{type:this.name,attrs:t}),setAlignImageMermaid:t=>({commands:e})=>e.updateAttributes(this.name,{align:t})}},renderHTML({HTMLAttributes:t}){const{align:e}=t;return["div",{style:e?`text-align: ${e};`:"",class:"imageMermaid"},["img",k.mergeAttributes(this.options.HTMLAttributes,t)]]},parseHTML(){return[{tag:"div[class=imageMermaid]",getAttrs:t=>{const e=t.querySelector("img"),r=e==null?void 0:e.getAttribute("width"),a=e==null?void 0:e.getAttribute("height");return{src:e==null?void 0:e.getAttribute("src"),alt:e==null?void 0:e.getAttribute("alt"),width:r?Number.parseInt(r,10):null,height:a?Number.parseInt(a,10):null,align:(e==null?void 0:e.getAttribute("align"))||t.style.textAlign||null}}}]}});exports.Mermaid=oe;

"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const g=require("./index-CSvnpArE.cjs"),L=require("scroll-into-view-if-needed"),i=require("react/jsx-runtime"),f=require("react"),y=require("./index-IVWsUqpH.cjs"),D=require("./ActionButton-DY0olRIe.cjs"),l=require("./events.constant-Cyyj4OFH.cjs"),_=require("./index-BObJ0_Vs.cjs"),T=require("./popover-C53Gavq8.cjs"),b=require("./Icon-R3ihBJhB.cjs"),N=require("./label-Dy0JqoBR.cjs"),P=require("./input-8Tv6i4jL.cjs"),C=require("./button-BT4Gvjni.cjs"),k=require("./switch-CyPKEcIe.cjs");function B({editor:e,...t}){const{t:s}=_.useLocale(),[c,n]=f.useState(-1),[r,a]=f.useState([]),[o,x]=f.useState(""),[u,h]=f.useState(""),[m,p]=f.useState(!1),[v,V]=f.useState(!1);return f.useEffect(()=>{m||(x(""),h(""),n(-1),a([]),e.commands.setSearchTerm(""),e.commands.setReplaceTerm(""))},[e,m]),f.useEffect(()=>{m&&e&&e.commands&&e.commands.setSearchTerm&&e.commands.setSearchTerm(o)},[m,o,e]),f.useEffect(()=>{m&&e&&e.commands&&e.commands.setReplaceTerm&&e.commands.setReplaceTerm(u)},[m,u,e]),f.useEffect(()=>{if(!e)return;const d=e.extensionManager.extensions.find(R=>R.name===w.name);if(!d)return;const j=()=>{if(!m)return;const R=d?d.storage.currentIndex:-1,I=d?d.storage.results:[];n(E=>E!==R?R:E),a(E=>y.deepEqual(E,I)?E:I)};return l.listenEvent(l.EVENTS.SEARCH_REPLCE,j),()=>{d&&l.listenEvent(l.EVENTS.SEARCH_REPLCE,j)}},[m,e]),i.jsxs(T.Popover,{onOpenChange:p,open:m,children:[i.jsx(T.PopoverTrigger,{asChild:!0,disabled:t==null?void 0:t.disabled,children:i.jsx(D.ActionButton,{disabled:t==null?void 0:t.disabled,isActive:t==null?void 0:t.isActive,tooltip:t==null?void 0:t.tooltip,children:i.jsx(b.IconComponent,{name:t==null?void 0:t.icon})})}),i.jsxs(T.PopoverContent,{align:"start",className:"richtext-w-full",hideWhenDetached:!0,side:"bottom",children:[i.jsxs("div",{className:"richtext-mb-[6px] richtext-flex richtext-items-center richtext-justify-between",children:[i.jsx(N.Label,{children:s("editor.search.dialog.text")}),i.jsx("span",{className:"richtext-font-semibold",children:r.length>0?`${c+1}/${r.length}`:"0/0"})]}),i.jsxs("div",{className:"richtext-mb-[10px] richtext-flex richtext-w-full richtext-max-w-sm richtext-items-center richtext-gap-1.5",children:[i.jsx(P.Input,{autoFocus:!0,className:"richtext-w-full",onChange:d=>x(d.target.value),placeholder:"Text",required:!0,type:"text",value:o}),i.jsx(C.Button,{className:"richtext-flex-1",disabled:r.length===0,onClick:e.commands.goToPrevSearchResult,children:i.jsx(b.IconComponent,{name:"ChevronUp"})}),i.jsx(C.Button,{className:"richtext-flex-1",disabled:r.length===0,onClick:e.commands.goToNextSearchResult,children:i.jsx(b.IconComponent,{name:"ChevronDown"})})]}),i.jsx(N.Label,{className:"richtext-mb-[6px]",children:s("editor.replace.dialog.text")}),i.jsx("div",{className:"richtext-mb-[5px] richtext-flex richtext-w-full richtext-max-w-sm richtext-items-center richtext-gap-1.5",children:i.jsx("div",{className:"richtext-relative richtext-w-full richtext-max-w-sm richtext-items-center",children:i.jsx(P.Input,{className:"richtext-w-80",onChange:d=>h(d.target.value),placeholder:"Text",required:!0,type:"text",value:u})})}),i.jsxs("div",{className:"richtext-mb-[10px] richtext-flex richtext-items-center richtext-space-x-2",children:[i.jsx(k.Switch,{checked:v,onCheckedChange:d=>{V(d),e.commands.setCaseSensitive(d)}}),i.jsx(N.Label,{children:s("editor.replace.caseSensitive")})]}),i.jsxs("div",{className:"richtext-flex richtext-items-center richtext-gap-[10px]",children:[i.jsx(C.Button,{className:"richtext-flex-1",disabled:r.length===0,onClick:e.commands.replace,children:s("editor.replace.dialog.text")}),i.jsx(C.Button,{className:"richtext-flex-1",disabled:r.length===0,onClick:e.commands.replaceAll,children:s("editor.replaceAll.dialog.text")})]})]})]})}const S=(e,t)=>t(e.tr);function H(e,t,s){return RegExp(t?e.replace(/[$()*+./?[\\\]^{|}-]/g,String.raw`\$&`):e,s?"gu":"gui")}function $(e,t,s){const c=[];let n=[];const r=[];let a=0;if(!t)return{decorationsToReturn:[],results:[]};e==null||e.descendants((o,x)=>{o.isText?n[a]?n[a]={text:n[a].text+o.text,pos:n[a].pos}:n[a]={text:`${o.text}`,pos:x}:a+=1}),n=n.filter(Boolean);for(const{text:o,pos:x}of n){const u=[...o.matchAll(t)];for(const h of u){if(h[0]==="")break;h.index!==void 0&&r.push({from:x+h.index,to:x+h.index+h[0].length})}}for(const o of r)c.push(g.Decoration.inline(o.from,o.to,{class:s}));return{decorationsToReturn:c,results:r}}function A(e,t,{state:s,dispatch:c}){if(!t[0])return;const{from:r,to:a}=t[0];c&&c(s.tr.insertText(e,r,a))}function M(e,t,s,c){const n=t+1;if(!c[n])return null;const{from:r,to:a}=c[t],o=a-r-e.length+s,{from:x,to:u}=c[n];return c[n]={to:u-o,from:x-o},[o,c]}function O(e,t,{tr:s,dispatch:c}){let n=0,r=t.slice();if(r.length===0)return!1;for(let a=0;a<r.length;a+=1){const{from:o,to:x}=r[a];s.insertText(e,o,x);const u=M(e,a,n,r);u&&(n=u[0],r=u[1])}return c(s),!0}function q({view:e,tr:t,searchResults:s,searchResultCurrentClass:c,gotoIndex:n}){const r=s[n];if(r){const a=t.setMeta("directDecoration",{fromPos:r.from,toPos:r.to,attrs:{class:c}});return e==null||e.dispatch(a),setTimeout(()=>{const o=window.document.querySelector(`.${c}`);o&&L(o,{behavior:"smooth",scrollMode:"if-needed"})},0),!0}return!1}const w=g.Extension.create({name:"search",addOptions(){var e;return{...(e=this.parent)==null?void 0:e.call(this),searchTerm:"",replaceTerm:"",results:[],currentIndex:0,searchResultClass:"search-result",searchResultCurrentClass:"search-result-current",caseSensitive:!1,disableRegex:!1,onChange:()=>{},button:({editor:t,t:s})=>({component:B,componentProps:{action:()=>{},icon:"SearchAndReplace",tooltip:s("editor.searchAndReplace.tooltip"),isActive:()=>!1,disabled:!1,editor:t}})}},addStorage(){return{results:[],currentIndex:-1}},addCommands(){return{setSearchTerm:e=>({state:t,dispatch:s})=>(this.options.searchTerm=e,this.storage.results=[],this.storage.currentIndex=0,l.dispatchEvent(l.EVENTS.SEARCH_REPLCE),S(t,s),!1),setReplaceTerm:e=>({state:t,dispatch:s})=>(this.options.replaceTerm=e,S(t,s),!1),setCaseSensitive:e=>({state:t,dispatch:s})=>(this.options.caseSensitive=e,S(t,s),!1),replace:()=>({state:e,dispatch:t})=>{const{replaceTerm:s}=this.options,{currentIndex:c,results:n}=this.storage,r=n[c];return r?(A(s,[r],{state:e,dispatch:t}),this.storage.results.splice(c,1)):(A(s,n,{state:e,dispatch:t}),this.storage.results.shift()),l.dispatchEvent(l.EVENTS.SEARCH_REPLCE),S(e,t),!1},replaceAll:()=>({state:e,tr:t,dispatch:s})=>{const{replaceTerm:c}=this.options,{results:n}=this.storage;return O(c,n,{tr:t,dispatch:s}),this.storage.currentIndex=-1,this.storage.results=[],l.dispatchEvent(l.EVENTS.SEARCH_REPLCE),S(e,s),!1},goToPrevSearchResult:()=>({view:e,tr:t})=>{const{searchResultCurrentClass:s}=this.options,{currentIndex:c,results:n}=this.storage,r=(c+n.length-1)%n.length;return this.storage.currentIndex=r,l.dispatchEvent(l.EVENTS.SEARCH_REPLCE),q({view:e,tr:t,searchResults:n,searchResultCurrentClass:s,gotoIndex:r})},goToNextSearchResult:()=>({view:e,tr:t})=>{const{searchResultCurrentClass:s}=this.options,{currentIndex:c,results:n}=this.storage,r=(c+1)%n.length;return this.storage.currentIndex=r,this.options.onChange&&this.options.onChange(),l.dispatchEvent(l.EVENTS.SEARCH_REPLCE),q({view:e,tr:t,searchResults:n,searchResultCurrentClass:s,gotoIndex:r})}}},addProseMirrorPlugins(){const e=this;return[new g.Plugin({key:new g.PluginKey("search"),state:{init(){return g.DecorationSet.empty},apply(t){const{doc:s,docChanged:c}=t,{searchTerm:n,searchResultClass:r,searchResultCurrentClass:a,disableRegex:o,caseSensitive:x}=e.options;if(c||n){const{decorationsToReturn:u,results:h}=$(s,H(n,o,x),r);if(e.storage.results=h,e.storage.currentIndex>h.length-1&&(e.storage.currentIndex=0),l.dispatchEvent(l.EVENTS.SEARCH_REPLCE),t.getMeta("directDecoration")){const{fromPos:m,toPos:p,attrs:v}=t.getMeta("directDecoration");u.push(g.Decoration.inline(m,p,v))}else h.length>0&&(u[0]=g.Decoration.inline(h[0].from,h[0].to,{class:a}));return g.DecorationSet.create(s,u)}return g.DecorationSet.empty}},props:{decorations(t){return this.getState(t)}}})]}});exports.SearchAndReplace=w;
